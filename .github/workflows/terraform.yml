# =============================================================================
# CI Pipeline for Virtual Host Live Stream
# =============================================================================
# Build, test, vÃ  push Docker images lÃªn GitHub Container Registry (ghcr.io)
# KhÃ´ng cáº§n AWS - cháº¡y local báº±ng docker-compose
# =============================================================================

name: 'CI Pipeline'

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main"]

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/virtual-host-livestream

permissions:
  contents: read
  packages: write
  pull-requests: write

jobs:
  # ============================================================================
  # Lint & Test Python Code
  # ============================================================================
  lint-test:
    name: 'Lint & Test'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pytest pytest-asyncio black isort
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Check code formatting with Black
        run: black --check --diff . || true
        continue-on-error: true

      - name: Check import sorting with isort
        run: isort --check-only --diff . || true
        continue-on-error: true

      - name: Lint with flake8
        run: |
          # Stop build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Warnings (exit-zero treats all errors as warnings)
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Run tests
        run: |
          if [ -d "tests" ]; then
            pytest tests/ -v --tb=short
          else
            echo "No tests directory found, skipping..."
          fi
        continue-on-error: true

  # ============================================================================
  # Build Docker Images
  # ============================================================================
  build:
    name: 'Build ${{ matrix.service.name }}'
    runs-on: ubuntu-latest
    needs: lint-test

    strategy:
      fail-fast: false
      matrix:
        service:
          - name: crawl-service
            dockerfile: docker/Dockerfile.crawl
            context: .
          - name: nlp-service
            dockerfile: docker/Dockerfile.nlp
            context: .
          - name: orchestrator-service
            dockerfile: docker/Dockerfile.orchestrator
            context: .
          - name: chat-service
            dockerfile: docker/Dockerfile.chat
            context: .
          - name: tts-service
            dockerfile: docker/Dockerfile.tts
            context: .
          - name: avatar-service
            dockerfile: docker/Dockerfile.avatar
            context: .
          - name: obs-service
            dockerfile: docker/Dockerfile.obs
            context: .

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check if Dockerfile exists
        id: check_dockerfile
        run: |
          if [ -f "${{ matrix.service.dockerfile }}" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Dockerfile not found: ${{ matrix.service.dockerfile }}"
          fi

      - name: Set up Docker Buildx
        if: steps.check_dockerfile.outputs.exists == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        if: steps.check_dockerfile.outputs.exists == 'true' && github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        if: steps.check_dockerfile.outputs.exists == 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service.name }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and Push
        if: steps.check_dockerfile.outputs.exists == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service.context }}
          file: ${{ matrix.service.dockerfile }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Summary
        if: steps.check_dockerfile.outputs.exists == 'true'
        run: |
          echo "### âœ… ${{ matrix.service.name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dockerfile: \`${{ matrix.service.dockerfile }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Image: \`${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service.name }}\`" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Docker Compose Validation
  # ============================================================================
  validate-compose:
    name: 'Validate Docker Compose'
    runs-on: ubuntu-latest
    needs: lint-test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate docker-compose.yml
        run: |
          cd docker
          docker compose config --quiet
          echo "âœ… docker-compose.yml is valid"

      - name: Check all Dockerfiles syntax
        run: |
          for dockerfile in docker/Dockerfile.*; do
            echo "Checking $dockerfile..."
            docker build --check -f "$dockerfile" . 2>/dev/null || echo "âš ï¸ Warning in $dockerfile"
          done
        continue-on-error: true

  # ============================================================================
  # Security Scan
  # ============================================================================
  security-scan:
    name: 'Security Scan'
    runs-on: ubuntu-latest
    needs: lint-test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
          format: 'table'

  # ============================================================================
  # Build Summary
  # ============================================================================
  summary:
    name: 'CI Summary'
    runs-on: ubuntu-latest
    needs: [lint-test, build, validate-compose, security-scan]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸš€ CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint & Test | ${{ needs.lint-test.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Images | ${{ needs.build.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Validate Compose | ${{ needs.validate-compose.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Run Locally" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "cd docker" >> $GITHUB_STEP_SUMMARY
          echo "docker compose up -d" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
